<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/common.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/loader.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/button.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/warLeague.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/cms/manager.css" />

  <script src="/static/js/common.js"></script>
  <script src="/static/js/api/league.js"></script>
  <script src="/static/js/api/clan.js"></script>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

  <title>클랜 관리</title>


  <script>
    async function addClan(element) {
      const cardElement = element.closest('.card');
      const { dataset } = cardElement;
      const { clanTag, clanName } = dataset;

      if (!confirm(`${clanName}(${clanTag})를 등록하시겠습니까?\n`)) {
        return;
      }

      const requestBody = {
        tag: clanTag,
        name: clanName
      }

      const registeredClan = await registerClan(requestBody)
      if (!registeredClan) {
        return;
      }

      const [clanDetail] = await fetchClansFromExternal([registeredClan]);
      clanDetail.order = registeredClan.order;
      clanDetail.clanContent = registeredClan.clanContent;
      const clansListElement = document.querySelector('.clan-list');
      renderClan(clanDetail, clansListElement);
    }

  function replaceFooter(searchResultElement) {
      const targetCardFooter = searchResultElement.querySelector('.card-footer');

      const clanCardRegisterFooterTemplate = document.querySelector("#clan-card-register-footer");
      const clanCardRegisterFooter = document.importNode(clanCardRegisterFooterTemplate.content, true);
      const cardFooter = clanCardRegisterFooter.querySelector('.card-footer');

      targetCardFooter.replaceWith(cardFooter);
    }

    function searchClan() {
        const searchInput = document.querySelector('#search-input');
        if (!searchInput.value) {
          alert('클랜 태그를 입력해주세요.');
          return;
        }

        findClan(searchInput.value)
        .then((clan) => {
          const searchResultElement = document.querySelector('.search-result');

          const searchedClanCard = searchResultElement.querySelector('.card');
          if (searchedClanCard) {
            searchResultElement.removeChild(searchedClanCard);
          }

          renderClan(clan, searchResultElement);
          replaceFooter(searchResultElement);
        })
    }

  function removeClan(element) {
      const cardElement = element.closest('.card');
      const { dataset } = cardElement;
      const { clanTag, clanName } = dataset;

      if (!confirm(`${clanName}(${clanTag})를 제거하시겠습니까?\n`)) {
        return;
      }

      deleteClan(clanTag)
        .then((response) => {
          cardElement.remove();
        })
    }

    function convYn(yn) {
      if (yn === 'Y') return "비노출"
      return "노출"
    }

    async function changeContentYn(element) {
      const cardElement = element.closest('.card');
      const { clanTag } = cardElement.dataset;
      const { dataset } = element;
      const { btnName, yn, menuName } = dataset;

      if (!confirm(`${btnName} 메뉴에서 ${convYn(yn)}하시겠습니까?`)) {
        return;
      }

      const changeYn = yn === 'Y' ? 'N' : 'Y';
      const requestBody = {}
      requestBody.tag = clanTag;
      requestBody[menuName] = changeYn;

      const result = await updateClanContent(requestBody);
      if (result) {
        // 성공 처리
        element.dataset.yn = changeYn;
        settingDisabled(element);
      }
    }

    let leagueMap = {}
    async function loadLeagues() {
      // 리그 목록 조회
      const leagues = await fetchLeagues();
      leagues.map(league => {
        leagueMap[league.name] = league;
      });
    }

    function makeClanMapByTag(clans) {
      return clans.reduce((map, clan) => {
        map[clan.tag] = clan
        return map
      }, {});
    }

    function renderClanBadge(badgeUrls, card) {
      if (!badgeUrls) return;

      const { small } = badgeUrls;
      if (small) {
        const clanBadge = card.querySelector('.clan-badge');
        clanBadge.src = small;
      }
    }

    function renderWarLeagueBadge(warLeague, card) {
      if (!warLeague) return;

      const { name } = warLeague;
      let warLeagueIconClassName = name.replace(/\s/g, "");

      const warLeagueElement = card.querySelector('.clan-war-league-badge');

      if (warLeagueIconClassName !== 'Unranked') {
        warLeagueElement.classList.add(warLeagueIconClassName);
        return;
      }

      const leagueLabel = leagueMap[name];
      if (leagueLabel) {
        const {iconUrls} = leagueLabel;
        const {small} = iconUrls;
        const imgElement = document.createElement('img');
        imgElement.src = small;
        imgElement.classList.add('clan-war-league-badge', 'icon');
        warLeagueElement.replaceWith(imgElement);
      }
    }

    function renderCapitalLeagueBadge(capitalLeague, card) {
      if (!capitalLeague) return;

      const { name } = capitalLeague;
      const leagueLabel = leagueMap[name];
      if (leagueLabel) {
        const { iconUrls } = leagueLabel;
        const { small } = iconUrls;
        const leagueBadge = card.querySelector('.capital-league-badge');
        leagueBadge.src = small;
      }
    }

    function findLeader(memberList) {
      return memberList.filter(member => member.role === 'leader');
    }

    function settingDataYn(btnElement, yn) {
      btnElement.dataset.yn = yn;
      settingDisabled(btnElement);
    }

    function settingDisabled(btnElement) {
      const { yn } = btnElement.dataset;
      if (yn === 'N') {
        btnElement.classList.add('disabled');
      } else {
        btnElement.classList.remove('disabled');
      }
    }

    function renderClanContent(clanContent, card) {
      if (!clanContent) return;

      const { tag, clanWarYn, clanWarLeagueYn, clanCapitalYn, clanWarParallelYn } = clanContent;

      const btnClanWar = card.querySelector('.btn-clan-war');
      settingDataYn(btnClanWar, clanWarYn);
      const btnClanWarLeague = card.querySelector('.btn-clan-war-league');
      settingDataYn(btnClanWarLeague, clanWarLeagueYn);
      const btnClanCapital = card.querySelector('.btn-clan-capital');
      settingDataYn(btnClanCapital, clanCapitalYn);

      const btnClanWarParallel = card.querySelector('.btn-clan-war-parallel');
      settingDataYn(btnClanWarParallel, clanWarParallelYn);
    }

    function renderClan(clan, targetElement) {
      const clanCardTemplate = document.querySelector("#clan-card");
      const clanCard = document.importNode(clanCardTemplate.content, true);
      const card = clanCard.querySelector('.card');

      const { name, tag, badgeUrls, warLeague, capitalLeague, memberList, clanContent } = clan;
      const [leader] = findLeader(memberList);

      // dataset
      card.dataset.clanTag = tag;
      card.dataset.clanName = name;

      card.innerHTML = card.innerHTML
                           .replace(/{CLAN_NAME}/, name)
                           .replace(/{CLAN_TAG}/, tag)
                           .replace(/{CLAN_LEADER}/, leader.name);

      renderClanBadge(badgeUrls, card);
      renderWarLeagueBadge(warLeague, card);
      renderCapitalLeagueBadge(capitalLeague, card);

      renderClanContent(clanContent, card);

      targetElement.appendChild(card);
    }

    function renderClans(clans) {
      const clansListElement = document.querySelector('.clan-list');
      clans.forEach((clan) => renderClan(clan, clansListElement))
    }

    async function getClans() {
      showWifiLoading('.clan-manager');
      let clans = await fetchClans();
      let clanDetailMap = makeClanMapByTag(await fetchClansFromExternal(clans));

      let resultClans = [];
      clans.forEach(clan => {
        // 객체 병합
        const clanDetail = clanDetailMap[clan.tag];
        clanDetail.order = clan.order;
        clanDetail.clanContent = clan.clanContent;
        resultClans.push(clanDetail);
      });

      renderClans(resultClans)

      hideWifiLoading('.clan-manager');
    }

    window.onload = async () => {
      await loadLeagues();
      await getClans();
    }
  </script>

</head>
<body>
<div class="clan-manager">
  <div id="wifi-loader" class="display-none">
    <svg class="circle-outer" viewBox="0 0 86 86">
      <circle class="back" cx="43" cy="43" r="40"></circle>
      <circle class="front" cx="43" cy="43" r="40"></circle>
      <circle class="new" cx="43" cy="43" r="40"></circle>
    </svg>
    <svg class="circle-middle" viewBox="0 0 60 60">
      <circle class="back" cx="30" cy="30" r="27"></circle>
      <circle class="front" cx="30" cy="30" r="27"></circle>
    </svg>
    <svg class="circle-inner" viewBox="0 0 34 34">
      <circle class="back" cx="17" cy="17" r="14"></circle>
      <circle class="front" cx="17" cy="17" r="14"></circle>
    </svg>
    <div class="text" data-text="Searching"></div>
  </div>

  <div class="form-register-clan">

    <div class="search w270">
      <div class="search-box">
        <div class="search-field">
          <input placeholder="클랜 태그를 입력해주세요..." class="input" type="text" id="search-input">
          <div class="search-box-icon">
            <button class="btn-icon-content" onclick="searchClan(); return false;">
              <i class="search-icon">
                <svg class="icon-search" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
              </i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="search-result">

    </div>
  </div>

  <div class="clan-list"></div>
</div>
</body>
<template id="clan-card">
  <div class="card">
    <div class="card-img">
      <img class="clan-badge icon">
      <div class="clan-war-league-badge img-icon icon"></div>
      <img class="capital-league-badge icon">
    </div>
    <div class="card-info">
      <div class="text-title">
        <span>{CLAN_NAME}</span>
      </div>
      <div class="text-body">
        <div class="chip">{CLAN_TAG}</div>
        <div class="chip bg-blue">{CLAN_LEADER}</div>
      </div>
    </div>
    <div class="card-footer">
      <div class="card-button btn-clan-war" data-btn-name="클랜전 현황" data-menu-name="clan_war_yn" onclick="changeContentYn(this); return false;">
        <i class="icon-clan-war"></i>
      </div>
      <div class="card-button btn-clan-war-league" data-btn-name="리그전 현황" data-menu-name="clan_war_league_yn" onclick="changeContentYn(this); return false;">
        <i class="icon-clan-war-league"></i>
      </div>
      <div class="card-button btn-clan-capital" data-btn-name="습격전 현황" data-menu-name="clan_capital_yn" onclick="changeContentYn(this); return false;">
        <i class="icon-clan-capital"></i>
      </div>
      <div class="card-button btn-clan-war-parallel" data-btn-name="병행클랜전 현황" data-menu-name="clan_war_parallel_yn" onclick="changeContentYn(this); return false;" style="filter: hue-rotate(45deg);">
        <i class="icon-clan-war"></i>
      </div>
      <div class="card-button color-red" onclick="removeClan(this); return false;">
        <i class="fa-regular fa-square-minus"></i>
      </div>
    </div>
  </div>
</template>
<template id="clan-card-register-footer">
  <div class="card-footer justify-content-right">
    <div class="card-button color-green" onclick="addClan(this); return false;">
      <i class="fa-regular fa-square-plus"></i>
    </div>
  </div>
</template>
</html>