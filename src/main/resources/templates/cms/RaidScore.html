<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/common.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/loader.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/button.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/cms/raidScore.css" />

  <script src="/static/js/common.js"></script>
  <script src="/static/js/util.js"></script>
  <script src="/static/js/api/raid.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <title>습격전 기록 조회</title>

  <script>
    function clearPlayerRiadScoreList() {
      let tableTbody = document.querySelector('.table-tbody');
      tableTbody.innerHTML = "";
    }

    function renderEmptyRow() {
      const raidRowEmptyTemplate = document.querySelector('#raid-row-empty-template');
      const raidRowEmptyElement = document.importNode(raidRowEmptyTemplate.content, true);
      const tableTbody = document.querySelector('.table-tbody');
      tableTbody.appendChild(raidRowEmptyElement);
    }

    function renderPlayerRaidScore(playerRaidScore) {
      const { name, tag, clan, seasonStartDate, seasonEndDate, resourceLooted, attacks } = playerRaidScore;

      const raidRowEmptyTemplate = document.querySelector('#raid-row-template');
      const raidRowEmptyElement = document.importNode(raidRowEmptyTemplate.content, true);
      const tableRow = raidRowEmptyElement.querySelector('.table-tr');

      const displayClanName = clan ? clan.name : '정보 없음'
      const seasonPeriod = `${formatYYYYMMDD(seasonStartDate)} ~ ${formatYYYYMMDD(seasonEndDate)}`
      tableRow.innerHTML = tableRow.innerHTML
                                   .replace(/{NAME}/, name)
                                   .replace(/{TAG}/, tag)
                                   .replace(/{CLAN_NAME}/, displayClanName)
                                   .replace(/{SEASON_PERIOD}/, seasonPeriod)
                                   .replace(/{SCORE}/, Number(resourceLooted).toLocaleString())
                                   .replace(/{ATTACKS}/, Number(attacks).toLocaleString());

      if (attacks < 6) {
        // 미공
        const spanAttacks = tableRow.querySelector('.span-attacks');
        spanAttacks.classList.add('color-red');
      }

      const tableTbody = document.querySelector('.table-tbody');
      tableTbody.appendChild(raidRowEmptyElement);
    }

    function renderPlayerRaidScores(playerRaidScores) {
      clearPlayerRiadScoreList();
      if (!playerRaidScores.length) {
        renderEmptyRow();
        return;
      }

      for(const playerRaidScore of playerRaidScores) {
        renderPlayerRaidScore(playerRaidScore);
      }
    }

    async function searchPlayerRaidScore(element) {
      let searchBox = element.closest('.search-box');
      let searchInput = searchBox.querySelector('.player-search-input');
      const playerTag = searchInput.value;
      if (!playerTag) {
        alert('플레이어 태그를 입력해주세요');
        return;
      }

      const playerRaidScores = await fetchPlayerRaidScore(playerTag);

      renderPlayerRaidScores(playerRaidScores);
    }
  </script>
</head>
<body>
  <div class="capital-raid">
    <div class="card caption">
      <div class="bottom-section">
        <span class="title">습격전 기록 조회</span>
      </div>
    </div>

    <div class="container">
      <div class="search">
        <div class="search-box">
          <div class="search-field">
            <input placeholder="플레이어 태그 입력" class="input player-search-input" type="text">
            <div class="search-box-icon">
              <button class="btn-icon-content" onclick="searchPlayerRaidScore(this); return false;">
                <i class="search-icon">
                  <svg class="icon-search" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
                </i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container contents">
      <table class="table">
        <thead class="table-thead">
        <tr class="table-tr">
          <th class="table-th">플레이어</th>
          <th class="table-th">태그</th>
          <th class="table-th">시즌</th>
          <th class="table-th">진행 클랜</th>
          <th class="table-th">점수</th>
          <th class="table-th">공격수</th>
        </tr>
        </thead>
        <tbody class="table-tbody"></tbody>
      </table>
    </div>
  </div>
</body>
<template id="raid-row-template">
  <tr class="table-tr">
    <td class="table-td">{NAME}</td>
    <td class="table-td"><span class="chip">{TAG}</span></td>
    <td class="table-td">{SEASON_PERIOD}</td>
    <td class="table-td"><span class="chip bg-green">{CLAN_NAME}</span></td>
    <td class="table-td">{SCORE}</td>
    <td class="table-td"><span class="span-attacks">{ATTACKS}</span></td>
  </tr>
</template>
<template id="raid-row-empty-template">
  <tr class="table-tr">
    <td class="table-td" colspan="5">플레이어 정보 없음</td>
  </tr>
</template>
</html>