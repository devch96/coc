<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/css/common.css" />
  <link rel="stylesheet" href="/static/css/loader.css" />
  <link rel="stylesheet" href="/static/css/clan/member.css" />
  <link rel="stylesheet" href="/static/css/townhall.css" />
  <link rel="stylesheet" href="/static/css/hero.css" />
  <link rel="stylesheet" href="/static/css/heroEquipment.css" />

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="/static/js/common.js"></script>

  <title>클랜원 현황</title>

  <script>
    function cardClick(e, event) {
      event.preventDefault();
      event.stopPropagation();

      const classList = e.closest('.member.row').classList;

      const activeClassName = 'active';
      if (classList.contains(activeClassName)) {
        classList.remove(activeClassName);
      } else {
        classList.add(activeClassName);
      }

      // 장비 보기 켜져 있으면 닫기
      e.querySelectorAll('.hero.active')
       .forEach((ele) => ele.classList.remove(activeClassName));
    }
    function heroClick(e, event) {
      event.preventDefault();
      event.stopPropagation();

      const classList = e.classList;

      const activeClassName = 'active';

      e.closest('.heroes')
       .querySelectorAll('.hero.active')
       .forEach((ele) => {
         if (ele !== e) {
           //다른 장비가 켜져있으면 닫기
           ele.classList.remove(activeClassName);
         }
       });

      if (classList.contains(activeClassName)) {
        classList.remove(activeClassName);
      } else {
        classList.add(activeClassName);
      }
    }

  async function requestClans() {
      return axios.get('/clans')
           .then((response) => {
             const { data } = response
             if (!data) {
               return [];
             }

             return data;
           })
           .catch((error) => {
             console.error(error);
             return [];
           });
    }
    function getRequestClanMembersByClan(clan) {
      const uri = `/clans/${encodeURIComponent(clan.tag)}/members`
      return axios.get(uri,
          {
            params: {
              clan: JSON.stringify(clan)
            }
          });
    }

    async function fetchClanMembers(clans) {
      const requests = clans.map(clan => getRequestClanMembersByClan(clan))

      const test = [requests[0]]

      let members = [];
      await axios.all(test)
                 .then((responses) => {
                   responses.forEach((response) => {
                     const { config, data } = response
                     if (data.members) {
                       // set clan
                       const clan = JSON.parse(config.params.clan)
                       data.members.forEach((member) => member.clan = clan)

                       // concat member
                       members = members.concat(data.members);
                     }
                   })
                 })
                 .catch((error) => {
                   console.error(error)
                 })

      return members;
    }

    function sortByTrophies(members) {
      return members.sort(function (a, b) {
        if (a.trophies < b.trophies) {
          return 1;
        }
        if (a.trophies > b.trophies) {
          return -1;
        }
        // a must be equal to b
        return 0;
      });
    }

    async function getClanMembers() {
      showWifiLoading('.content-wrapper');
      const clans = await requestClans();
      const members = await fetchClanMembers(clans)
      hideWifiLoading('.content-wrapper');

      const sortedMembers = sortByTrophies(members)

      const test = [sortedMembers[0]]
      renderMembers(test)
    }

    function fetchPlayer(tag) {
      const uri = `/players/${encodeURIComponent(tag)}`;

      return axios.get(uri)
                  .then((response) => {
                    const { data } = response
                    if (!data) {
                      return {};
                    }

                    return data;
                  })
                  .catch((error) => {
                    console.error(error);
                    return {};
                  });
    }

    function renderEquipment(equipmentWrapperElement, equipment) {
      const { name, level, maxLevel, village } = equipment;

      // 본 마을 영웅 장비만 표기
      if (village !== 'home') return;

      const heroEquipmentTemplate = document.querySelector('#member-hero-equipment');
      const heroEquipment = document.importNode(heroEquipmentTemplate.content, true);
      const equipmentElement = heroEquipment.querySelector('.equipment');

      let equipmentIconClassName = name.toLowerCase().replace(/\s/g, "_")
      equipmentElement.classList.add(equipmentIconClassName);

      equipmentElement.innerHTML = equipmentElement.innerHTML
                                                   .replace(/{LEVEL}/, level)
                                                   .replace(/{IS_MAX}/, level === maxLevel ? 'is-max' : '');

      equipmentWrapperElement.appendChild(equipmentElement);
    }

    function renderEquipments(heroElement, equipments) {
      const equipmentWrapperElement = heroElement.querySelector('.equipment-wrapper');

      for(const equipment of equipments) {
        renderEquipment(equipmentWrapperElement, equipment);
      }
    }

    function renderHero(memberHtml, hero) {
      const { name, level, maxLevel, village, equipments } = hero;

      // 본 마을 영웅만 표기
      if (village !== 'home') return;

      const heroesElement = memberHtml.querySelector('.inner-section.heroes');
      const memberHeroTemplate = document.querySelector('#member-hero');
      const memberHero = document.importNode(memberHeroTemplate.content, true);
      const heroElement = memberHero.querySelector('.hero');


      let heroIconClassName = name.toLowerCase().replace(/\s/g, "_")
      heroElement.classList.add(heroIconClassName);

      heroElement.innerHTML = heroElement.innerHTML
                                         .replace(/{LEVEL}/, level)
                                         .replace(/{IS_MAX}/, level === maxLevel ? 'is-max' : '');

      heroesElement.appendChild(heroElement);

      renderEquipments(heroElement, equipments)
    }

    function renderHeroes(memberHtml, player) {
      const { heroes } = player
      if (!heroes) return;

      for (const hero of heroes) {
        setTimeout(() => {
          renderHero(memberHtml, hero);
        }, 0)
      }
    }


    function renderHeroEquipments(memberHtml, player) {
      const { heroEquipments } = player
      if (!heroEquipments) return;

      const innerSectionTemplate = document.querySelector('#inner-section');

      const innerSection = document.importNode(innerSectionTemplate.content, true);
      const innerSectionElement = innerSection.querySelector('.inner-section');

      innerSectionElement.innerHTML = innerSectionElement.innerHTML
                                                         .replace(/{LABEL}/, '영웅 장비');

      const contentsElement = innerSectionElement.querySelector('.contents');
      for (const heroEquipment of heroEquipments) {
        renderEquipment(contentsElement, heroEquipment);
      }

      const cardBackElement = memberHtml.querySelector('.card-back');
      cardBackElement.appendChild(innerSectionElement);
    }

    async function renderPlayerDetail(memberHtml, tag) {
      fetchPlayer(tag).then((player) => {
        renderHeroes(memberHtml, player);
        renderHeroEquipments(memberHtml, player);
      })

    }

    function renderMembers(members) {
      const clanMembersElement = document.querySelector('.clan-members');

      const memberTemplate = document.querySelector('#member');
      let no = 1;
      for(const member of members) {
        const templateMember = document.importNode(memberTemplate.content, true);
        const memberHtml = templateMember.querySelector('.member');

        const { name, tag, clan, townHallLevel, expLevel, league, trophies, donations, donationsReceived } = member

        memberHtml.innerHTML = memberHtml.innerHTML
                                         .replace(/{NAME}/, name)
                                         .replace(/{CLAN_NAME}/, clan.name)
                                         .replace(/{TROPHIES}/, trophies)
                                         .replace(/{TOWN_HALL_LEVEL}/, townHallLevel)
                                         .replace(/{EXP_LEVEL}/, expLevel)
                                         .replace(/{DONATIONS}/, Number(donations).toLocaleString())
                                         .replace(/{DONATIONS_RECEIVED}/, Number(donationsReceived).toLocaleString());

        const leagueIconImg = memberHtml.querySelector('.cell.league-icon');
        const { iconUrls } = league
        leagueIconImg.src = iconUrls.tiny;

        clanMembersElement.appendChild(memberHtml);
        no++;

        setTimeout(() => {
          renderPlayerDetail(memberHtml, tag);
        }, 0)
      }
    }
  </script>
</head>
<body onload="getClanMembers()">
  <div class="content-wrapper">
    <div id="wifi-loader" class="display-none">
      <svg class="circle-outer" viewBox="0 0 86 86">
        <circle class="back" cx="43" cy="43" r="40"></circle>
        <circle class="front" cx="43" cy="43" r="40"></circle>
        <circle class="new" cx="43" cy="43" r="40"></circle>
      </svg>
      <svg class="circle-middle" viewBox="0 0 60 60">
        <circle class="back" cx="30" cy="30" r="27"></circle>
        <circle class="front" cx="30" cy="30" r="27"></circle>
      </svg>
      <svg class="circle-inner" viewBox="0 0 34 34">
        <circle class="back" cx="17" cy="17" r="14"></circle>
        <circle class="front" cx="17" cy="17" r="14"></circle>
      </svg>
      <div class="text" data-text="Searching"></div>
    </div>


    <div class="clan-members"></div>
  </div>
</body>
<template id="member">
  <div class="member row" onclick="cardClick(this, event); return false;">
    <div class="card-front">
      <div class="layout-title">
        <div class="cell">
          <div class="user">{NAME}</div>
          <div class="label-clan">{CLAN_NAME}</div>
        </div>
        <div class="cell trophies">
          <div class="count">
            {TROPHIES}
            <div class="icon"></div>
          </div>
        </div>
      </div>
      <div class="inner-section">
        <div class="layout-badge">
          <img class="cell league-icon" src="" alt="">
          <div class="cell town-hall th{TOWN_HALL_LEVEL}"></div>
          <div class="cell xp"><span class="level">{EXP_LEVEL}</span></div>
        </div>
        <div class="layout-donations">
          <div class="cell donations">
            <span class="label">지원</span>
            <span class="count">{DONATIONS}</span>
          </div>
          <div class="cell donations-received">
            <span class="label">받음</span>
            <span class="count">{DONATIONS_RECEIVED}</span>
          </div>
        </div>
      </div>
      <div class="inner-section heroes"></div>
    </div>
    <div class="card-back"></div>
  </div>
</template>
<template id="inner-section">
  <div class="inner-section">
    <div class="label">{LABEL}</div>
    <div class="contents"></div>
  </div>
</template>
<template id="member-hero">
  <div class="hero" onclick="heroClick(this, event); return false;">
    <div class="level-icon {IS_MAX}">{LEVEL}</div>
    <div class="equipment-wrapper"></div>
  </div>
</template>
<template id="member-hero-equipment">
  <div class="equipment">
    <div class="level-icon {IS_MAX}">{LEVEL}</div>
  </div>
</template>
</html>